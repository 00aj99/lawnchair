var Lawnchair=function(options){this.init(options)};Lawnchair.prototype={init:function(options){var that=this;var merge=that.merge;var opts=(typeof arguments[0]=="string")?{table:options}:options;this.name=merge("Lawnchair",opts.name);this.version=merge("1.0",opts.version);this.table=merge("field",opts.table);this.display=merge("shed",opts.display);this.max=merge(65536,opts.max);this.db=merge(null,opts.db);this.onError=function(){};this.onData=function(){};if(!window.openDatabase){throw ('Lawnchair, "This browser does not support sqlite storage."')}this.db=openDatabase(this.name,this.version,this.display,this.max);this.db.transaction(function(tx){tx.executeSql("SELECT COUNT(*) FROM "+that.table,[],function(){},function(tx,error){tx.executeSql("CREATE TABLE "+that.table+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",[],function(){},that.onError)})})},get:function(key,callback){var that=this;this.db.transaction(function(t){t.executeSql("SELECT value FROM "+that.table+" WHERE id = ?",[key],function(tx,results){if(results.rows.length==0){callback(null)}else{var o=that.deserialize(results.rows.item(0).value);o.key=key;callback(o)}},this.onError)})},remove:function(keyOrObj){var that=this;this.db.transaction(function(t){t.executeSql("DELETE FROM "+that.table+" WHERE id = ?",[(typeof keyOrObj=="string")?keyOrObj:keyOrObj.key],that.onData,that.onError)})},save:function(obj,callback){var that=this;if(obj.key!=undefined){this.get(obj.key,function(r){that.db.transaction(function(t){var id=obj.key;delete (obj.key);t.executeSql("UPDATE "+that.table+" SET value=?, timestamp=? WHERE id=?",[that.serialize(obj),that.now(),id],function(tx,results){if(callback!=undefined){obj.key=id;callback(obj)}},that.onError)})})}else{this.db.transaction(function(t){if(obj.key==undefined){var id=that.uuid()}else{var id=obj.key;delete (obj.key)}t.executeSql("INSERT INTO "+that.table+" (id, value,timestamp) VALUES (?,?,?)",[id,that.serialize(obj),that.now()],function(tx,results){if(callback!=undefined){obj.key=id;callback(obj)}},that.onError)})}},nuke:function(){var that=this;this.db.transaction(function(t){t.executeSql("DELETE FROM "+that.table,[],that.onData,that.onError)});return this||that},find:function(condition,callback){var is=(typeof condition=="string")?function(r){return eval(condition)}:condition;var cb=this.terseToVerboseCallback(callback);this.each(function(record,index){if(is(record)){cb(record,index)}})},each:function(callback){var cb=this.terseToVerboseCallback(callback);this.all(function(results){var l=results.length;for(var i=0;i<l;i++){cb(results[i],i)}})},all:function(callback){var cb=this.terseToVerboseCallback(callback);var that=this;this.db.transaction(function(t){t.executeSql("SELECT * FROM "+that.table,[],function(tx,results){if(results.rows.length==0){cb([])}else{var r=[];for(var i=0;i<results.rows.length;i++){var raw=results.rows.item(i).value;var obj=that.deserialize(raw);obj.key=results.rows.item(i).id;r.push(obj)}cb(r)}},that.onError)})},merge:function(defaultOption,userOption){return(userOption==undefined||userOption==null)?defaultOption:userOption},terseToVerboseCallback:function(callback){return(typeof arguments[0]=="string")?function(r){eval(callback)}:callback},now:function(){return new Date().getTime()},uuid:function(len,radix){var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");var uuid=[];radix=radix||chars.length;if(len){for(var i=0;i<len;i++){uuid[i]=chars[0|Math.random()*radix]}}else{var r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-";uuid[14]="4";for(var i=0;i<36;i++){if(!uuid[i]){r=0|Math.random()*16;uuid[i]=chars[(i==19)?(r&3)|8:r]}}}return uuid.join("")},serialize:function(obj){var r="";if(typeof JSON!="undefined"){r=JSON.stringify(obj)}else{r="{";var size=0;for(var x in obj){size++}var len=0;for(var i in obj){len++;r+='"'+i+'":';r+=typeof obj[i]=="string"?'"'+obj[i]+'"':obj[i];r+=len<size?",":""}r+="}"}return r},deserialize:function(json){return eval("("+json+")")}};